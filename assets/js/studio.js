
const Studio = (()=>{
  // Text to Speech
  const tts = window.speechSynthesis;
  function loadVoices(){
    const sel = document.getElementById('ttsVoice');
    if(!sel) return;
    sel.innerHTML = '';
    const voices = tts.getVoices().filter(v=>/en/i.test(v.lang));
    voices.forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`;
      sel.appendChild(opt);
    });
  }
  function speak(){
    const text = (document.getElementById('ttsText')||{}).value || '';
    if(!text) return;
    tts.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const voiceName = (document.getElementById('ttsVoice')||{}).value;
    const voice = tts.getVoices().find(v=>v.name===voiceName);
    if(voice) u.voice = voice;
    u.rate = parseFloat((document.getElementById('ttsRate')||{}).value || 1.0);
    u.pitch = parseFloat((document.getElementById('ttsPitch')||{}).value || 1.0);
    tts.speak(u);
  }
  function stop(){ tts.cancel(); }

  // Text -> Image Poster (Canvas)
  function drawPoster(){
    const c = document.getElementById('poster');
    if(!c) return;
    const ctx = c.getContext('2d');
    const W=c.width, H=c.height;
    // background gradient using brand colors
    const g = ctx.createLinearGradient(0,0,W,H);
    g.addColorStop(0,'#F5F5F7');
    g.addColorStop(0.4,'#E4A0B7');
    g.addColorStop(1,'#7B6CF6');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    // subtle overlay waves
    ctx.globalAlpha=0.18;
    for(let i=0;i<8;i++){
      const y = (H/8)*i + 40;
      ctx.fillStyle = i%2 ? '#004E89' : '#FFFFFF';
      ctx.beginPath(); ctx.ellipse(W/2, y, W*0.7, 40, 0, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
    // text
    const headline = (document.getElementById('t2iHeadline')||{}).value || 'Athenia';
    const sub = (document.getElementById('t2iSub')||{}).value || '';
    ctx.fillStyle = '#0E0E11';
    ctx.font = 'bold 96px Montserrat, sans-serif';
    wrapText(ctx, headline, 80, H*0.42, W-160, 104);
    ctx.fillStyle = '#0E0E11';
    ctx.font = '28px Lora, serif';
    wrapText(ctx, sub, 80, H*0.62, W-160, 36);
  }
  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const words = text.split(' ');
    let line='';
    for(let n=0;n<words.length;n++){
      const test = line + words[n] + ' ';
      const w = ctx.measureText(test).width;
      if(w>maxWidth && n>0){ ctx.fillText(line, x,y); line = words[n] + ' '; y+=lineHeight; }
      else line = test;
    }
    ctx.fillText(line, x, y);
  }
  function downloadPoster(){
    const c = document.getElementById('poster'); if(!c) return;
    const a = document.createElement('a');
    a.href = c.toDataURL('image/png');
    a.download = 'athenia_poster.png';
    a.click();
  }

  // Website Generator (single-file landing)
  let lastHTML = '';
  function generateSite(){
    const title = val('siteTitle') || 'Athenia Landing';
    const cta = val('siteCTA') || 'View Pricing';
    const sections = (val('siteSections')||'Overview\nBenefits\nGet Started').split(/\n+/);
    const html = `<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHTML(title)}</title>
<style>
:root{--blue:#004E89;--violet:#7B6CF6;--rose:#E4A0B7;--pearl:#F5F5F7;--ink:#0E0E11}
body{margin:0;background:var(--pearl);font-family:Lora,serif;color:var(--ink)}
h1,h2{font-family:Montserrat,sans-serif}
.wrapper{max-width:1080px;margin:0 auto;padding:24px}
.btn{display:inline-block;border:1px solid var(--blue);padding:10px 16px;border-radius:999px;text-decoration:none;color:var(--ink)}
.btn.filled{background:linear-gradient(135deg,var(--rose),var(--violet));border-color:transparent;color:#fff}
.card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:18px}
.hero{padding:64px 0;background:linear-gradient(180deg,#fff,rgba(228,160,183,.15))}
.grid{display:grid;gap:18px;grid-template-columns:1fr 1fr}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
</style></head><body>
<header class="wrapper"><strong style="letter-spacing:.06em">ATHENIA</strong></header>
<main>
<section class="hero"><div class="wrapper"><h1>${escapeHTML(title)}</h1><p>Luxury‑minimal template generated by Athenia Studio.</p><a class="btn filled" href="#">${escapeHTML(cta)}</a></div></section>
<section class="wrapper grid">
${sections.map(s=>`<div class="card"><h2>${escapeHTML(s)}</h2><p>Write a short paragraph about ${escapeHTML(s)} here.</p></div>`).join('')}
</section></main>
<footer class="wrapper" style="opacity:.7">© Athenia</footer>
</body></html>`;
    lastHTML = html;
    const box = document.getElementById('sitePreview');
    if(box) box.textContent = html;
  }
  function downloadSite(){
    if(!lastHTML) generateSite();
    const blob = new Blob([lastHTML], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'athenia_landing.html';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }
  function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }
  const val = id => (document.getElementById(id)||{}).value || '';

  // Leads Tracker with CSV import/export
  const leads = [];
  function addLead(){
    const name=val('leadName'), email=val('leadEmail'), notes=val('leadNotes');
    if(!name && !email) return;
    leads.push({name,email,notes});
    renderLeads();
    ['leadName','leadEmail','leadNotes'].forEach(id=>document.getElementById(id).value='');
  }
  function renderLeads(){
    const tbody = document.querySelector('#leadTable tbody');
    tbody.innerHTML = leads.map(l=>`<tr><td>${escapeHTML(l.name||'')}</td><td>${escapeHTML(l.email||'')}</td><td>${escapeHTML(l.notes||'')}</td></tr>`).join('');
  }
  function exportCSV(){
    const rows = [['Name','Email','Notes'], ...leads.map(l=>[l.name,l.email,l.notes])];
    const csv = rows.map(r=>r.map(cell=>`"${(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download='athenia_leads.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }
  function importCSV(ev){
    const f = ev.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const lines = String(reader.result).split(/\r?\n/).filter(Boolean);
      const data = lines.slice(1).map(line=>line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"')));
      data.forEach(([name,email,notes])=> leads.push({name,email,notes}));
      renderLeads();
    };
    reader.readAsText(f);
  }

  // Blog Assistant & Sales Copy Assistant (client-side templates)
  function blog(){
    const topic = val('blogTopic'); const tone = val('blogTone');
    const out = `BLOG OUTLINE\\nTopic: ${topic}\\nTone: ${tone}\\n\\nOutline\\n1) The Principle: Why ${topic} matters now\\n2) The Stakes: Risks of ignoring it\\n3) The Practice: How to implement with integrity\\n4) The Proof: Metrics and outcomes\\n\\nIntro\\n${topic} is no longer optional. Leaders who embrace it design continuity — balancing speed with stewardship.`;
    document.getElementById('blogOut').textContent = out;
  }
  function copy(){
    const prod = val('copyProduct'), aud = val('copyAudience'), outc = val('copyOutcome');
    const out = `SALES COPY\\nHeadline: ${prod} — Power with Integrity\\nSubhead: ${aud} get ${outc} without chaos.\\nBullets\\n• Governance as product\\n• Zero‑drama deployment\\n• Transparent metrics\\nCTA: Begin with clarity`;
    document.getElementById('copyOut').textContent = out;
  }

  // Init
  function init(){
    // TTS voices
    if('speechSynthesis' in window){
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }
    drawPoster();
    renderLeads();
  }
  return {speak, stop, drawPoster, downloadPoster, generateSite, downloadSite, addLead, exportCSV, importCSV, blog, copy, init};
})();
window.addEventListener('DOMContentLoaded', Studio.init);
